dist: goreleaser
version: 2

project_name: khulnasoft

builds:
- &khulnasoftbin
  id: khulnasoft
  binary: khulnasoft
  dir: pkg
  main: ./cmd/khulnasoft
  gobinary: ../scripts/go-wrapper.sh
  env:
  - GO111MODULE=on
  goos: ['linux', 'darwin', 'windows']
  goarch: ['amd64', 'arm64']
  goamd64: ['v1']
  ldflags:
    - -X github.com/khulnasoft/khulnasoft/pkg/v3/version.Version=v{{.Env.PULUMI_VERSION}}
  mod_timestamp: '{{ .CommitTimestamp }}'
  tags:
    # Enforce the pure Go implementation of os/user, even when cgo is available.
    # See https://pkg.go.dev/os/user#pkg-overview.
    - osusergo
- <<: *khulnasoftbin
  id: khulnasoft-language-go
  binary: khulnasoft-language-go
  dir: sdk/go/khulnasoft-language-go
  main: ./
  gobinary: ../../../scripts/go-wrapper.sh
- <<: *khulnasoftbin
  id: khulnasoft-language-nodejs
  binary: khulnasoft-language-nodejs
  dir: sdk/nodejs/cmd/khulnasoft-language-nodejs
  main: ./
  gobinary: ../../../../scripts/go-wrapper.sh
- <<: *khulnasoftbin
  id: khulnasoft-language-python
  binary: khulnasoft-language-python
  dir: sdk/python/cmd/khulnasoft-language-python
  main: ./
  gobinary: ../../../../scripts/go-wrapper.sh
- <<: *khulnasoftbin
  id: khulnasoft-display-wasm
  binary: khulnasoft-display
  dir: pkg
  main: ./backend/display/wasm
  goos: ['js']
  goarch: ['wasm']
  hooks:
    post:
      # Check the size of the WASM module.
      - |
        sh -c "[ `du -k {{ .Path }} | cut -f1` -le 79182 ] || (echo 'error: WASM module > 77M'; exit 1)"

archives:
- id: khulnasoft
  wrap_in_directory: khulnasoft{{ if eq .Os "windows" }}/bin{{ end }}
  format_overrides:
    - goos: windows
      format: zip
  files:
      # OS specific scripts, not compiled
    - src: bin/{{ .Os }}/*
      dst: '.'
      strip_parent: true
      # binaries
    - src: 'bin/{{ .Os }}-{{ if eq .Arch "amd64" }}x64{{ else }}{{ .Arch }}{{ end }}/*'
      dst: '.'
      strip_parent: true
  name_template: '{{ .ProjectName }}-{{ .Tag }}-{{ .Os }}-{{ if eq .Arch "amd64" }}x64{{ else }}{{ .Arch }}{{ end }}'

snapshot:
  name_template: "{{ .Version }}-SNAPSHOT"

checksum:
  name_template: "{{ .ProjectName }}-{{ .Version }}-checksums.txt"
